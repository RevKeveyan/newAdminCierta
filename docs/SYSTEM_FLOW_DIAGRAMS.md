# Схемы работы системы

## 1. Создание Load - Полный процесс

```
┌─────────────────────────────────────────────────────────────────┐
│                    ФРОНТЕНД: Создание Load                      │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Пользователь заполняет форму:                                  │
│  - Customer данные (новые или выбор существующего)              │
│  - Carrier данные (новые или выбор существующего)               │
│  - Тип груза (freight/vehicle)                                  │
│  - Pickup/Delivery адреса                                       │
│  - Файлы (изображения, документы)                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  POST /api/loads (multipart/form-data)                          │
│  Body: FormData с JSON строками и файлами                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              СЕРВЕР: LoadController.create()                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                ▼                           ▼
┌───────────────────────────┐  ┌───────────────────────────┐
│  Обработка Customer       │  │  Обработка Carrier        │
│                           │  │                           │
│  findOrCreateCustomer()   │  │  findOrCreateCarrier()    │
│                           │  │                           │
│  1. Проверка customer.id  │  │  1. Проверка carrier.id   │
│  2. Поиск по companyName  │  │  2. Поиск по mcNumber     │
│  3. Создание нового       │  │  3. Поиск по dotNumber    │
│  4. Обновление данных     │  │  4. Поиск по name         │
│                           │  │  5. Создание нового       │
│  → customerId             │  │  6. Обновление данных     │
└───────────────────────────┘  │                           │
                │               │  → carrierId               │
                └───────┬───────┘                           │
                        │                                   │
                        ▼                                   │
┌───────────────────────────────────────────────────────────┐
│  Подготовка данных Load:                                   │
│  - Генерация orderId (если не указан)                      │
│  - Генерация billOfLadingNumber (CC-XXXX)                  │
│  - Связывание customerId и carrierId                      │
│  - Обработка загруженных файлов                           │
└───────────────────────────────────────────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────────────────┐
│  Создание Load в базе данных                                │
│  const load = new Load(loadData)                           │
│  await load.save()                                         │
└───────────────────────────────────────────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────────────────┐
│  Обновление связей:                                        │
│  - Customer.loads.push(loadId)                            │
│  - Carrier.loads.push(loadId)                             │
└───────────────────────────────────────────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────────────────┐
│  Генерация BOL PDF                                         │
│  pdfService.generateBOL(loadData)                        │
└───────────────────────────────────────────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────────────────┐
│  Создание записи в истории                                 │
│  LoadHistory.create({ action: 'created' })                │
└───────────────────────────────────────────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────────────────┐
│  Форматирование через DTO                                  │
│  LoadDTO.format(load)                                     │
└───────────────────────────────────────────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────────────────┐
│  Ответ сервера:                                           │
│  {                                                        │
│    success: true,                                         │
│    data: { formatted load data },                        │
│    message: "Load created successfully"                   │
│  }                                                        │
└───────────────────────────────────────────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────────────────┐
│  ФРОНТЕНД: Получение ответа                                │
│  - Отображение созданного Load                            │
│  - Показ ID созданных Customer/Carrier                     │
│  - Сохранение для дальнейшего использования               │
└───────────────────────────────────────────────────────────┘
```

## 2. Логика поиска и создания Carrier

```
┌─────────────────────────────────────────────────────────────┐
│  Входные данные: carrierData                                │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  Есть carrier.id?     │
        └───────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
       ДА                      НЕТ
        │                       │
        ▼                       ▼
┌───────────────┐      ┌──────────────────┐
│ Найти по ID   │      │ Поиск по полям:   │
│ Carrier.findById(id) │                    │
└───────────────┘      └──────────────────┘
        │                       │
        │                       ▼
        │              ┌────────────────────┐
        │              │ Есть mcNumber?    │
        │              └────────────────────┘
        │                       │
        │              ┌─────────┴─────────┐
        │              │                   │
        │             ДА                  НЕТ
        │              │                   │
        │              ▼                   ▼
        │      ┌──────────────┐   ┌──────────────┐
        │      │ Поиск по     │   │ Есть         │
        │      │ mcNumber     │   │ dotNumber?   │
        │      └──────────────┘   └──────────────┘
        │              │                   │
        │              │          ┌────────┴────────┐
        │              │          │                │
        │              │         ДА               НЕТ
        │              │          │                │
        │              │          ▼                ▼
        │              │   ┌──────────────┐  ┌──────────────┐
        │              │   │ Поиск по      │  │ Есть name +  │
        │              │   │ dotNumber     │  │ companyName? │
        │              │   └──────────────┘  └──────────────┘
        │              │          │                │
        │              │          │        ┌───────┴───────┐
        │              │          │        │               │
        │              │          │       ДА              НЕТ
        │              │          │        │               │
        │              │          │        ▼               ▼
        │              │          │  ┌──────────┐  ┌──────────┐
        │              │          │  │ Поиск по  │  │ Поиск по │
        │              │          │  │ name +    │  │ name     │
        │              │          │  │ company   │  └──────────┘
        │              │          │  └──────────┘       │
        │              │          │        │             │
        │              │          │        └──────┬───────┘
        │              │          │             │
        │              └──────────┴─────────────┘
        │                         │
        │              ┌───────────┴───────────┐
        │              │                      │
        │            НАЙДЕН                НЕ НАЙДЕН
        │              │                      │
        │              ▼                      ▼
        │      ┌──────────────┐      ┌──────────────┐
        │      │ Обновить     │      │ Создать      │
        │      │ существующего│      │ нового       │
        │      │ Carrier      │      │ Carrier      │
        │      └──────────────┘      └──────────────┘
        │              │                      │
        │              └──────────┬───────────┘
        │                         │
        └─────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  Вернуть carrier._id  │
        └───────────────────────┘
```

## 3. Логика поиска и создания Customer

```
┌─────────────────────────────────────────────────────────────┐
│  Входные данные: customerData                               │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  Есть customer.id?   │
        └───────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
       ДА                      НЕТ
        │                       │
        ▼                       ▼
┌───────────────┐      ┌──────────────────┐
│ Найти по ID   │      │ Проверка:         │
│ Customer.findById(id) │ companyName есть? │
└───────────────┘      └──────────────────┘
        │                       │
        │              ┌─────────┴─────────┐
        │              │                   │
        │             ДА                  НЕТ
        │              │                   │
        │              ▼                   ▼
        │      ┌──────────────┐   ┌──────────────┐
        │      │ Поиск по     │   │ Вернуть null │
        │      │ companyName  │   │ (нельзя      │
        │      │ (case-insensitive)│ создать)     │
        │      └──────────────┘   └──────────────┘
        │              │
        │      ┌────────┴────────┐
        │      │                 │
        │    НАЙДЕН          НЕ НАЙДЕН
        │      │                 │
        │      ▼                 ▼
        │ ┌──────────┐    ┌──────────┐
        │ │ Обновить │    │ Создать  │
        │ │ существующего│ │ нового   │
        │ │ Customer │    │ Customer │
        │ └──────────┘    └──────────┘
        │      │                 │
        │      └────────┬────────┘
        │               │
        └───────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │  Вернуть customer._id │
        └───────────────────────┘
```

## 4. Структура базы данных - Связи

```
┌─────────────────┐
│     User        │
│  (createdBy)    │
└────────┬────────┘
         │
         │ 1:N
         │
         ▼
┌─────────────────┐         ┌─────────────────┐
│      Load       │◄────────┤   LoadHistory   │
│                 │   1:N   │                 │
└────────┬────────┘         └─────────────────┘
         │
         │ N:1
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌─────────┐ ┌──────────┐
│Customer │ │ Carrier  │
│         │ │          │
└─────────┘ └──────────┘
    │            │
    │ N:M        │ N:M
    │            │
    └─────┬──────┘
          │
          ▼
    ┌─────────┐
    │  Load   │
    └─────────┘
```

## 5. Поток данных при обновлении Load

```
┌─────────────────────────────────────────────────────────────┐
│  PUT /api/loads/:id/full                                     │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  LoadController.updateLoad()                                 │
│  1. Получить старый Load (для истории)                      │
│  2. Обработать Customer (findOrCreateCustomer)              │
│  3. Обработать Carrier (findOrCreateCarrier)                │
│  4. Подготовить данные обновления                           │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  Обновление Load в базе данных                               │
│  Load.findByIdAndUpdate(id, updateData)                     │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  Обновление связей:                                         │
│  - Если customer изменился:                                 │
│    * Удалить loadId из старого Customer.loads              │
│    * Добавить loadId в новый Customer.loads                 │
│  - Если carrier изменился:                                  │
│    * Удалить loadId из старого Carrier.loads                │
│    * Добавить loadId в новый Carrier.loads                  │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  Регенерация BOL PDF (если данные изменились)               │
│  - Удалить старый PDF                                       │
│  - Сгенерировать новый PDF                                  │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  Запись в историю изменений                                 │
│  LoadHistory.create({                                       │
│    action: 'updated',                                       │
│    changes: [{ field, oldValue, newValue }]                 │
│  })                                                         │
└─────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  Форматирование и ответ                                     │
│  LoadDTO.format(updatedLoad)                                │
└─────────────────────────────────────────────────────────────┘
```

## 6. Формат данных - Request/Response

### Создание Load - Request

```
FormData {
  customer: JSON.stringify({
    id?: string,              // Опционально: ID существующего
    companyName: string,      // Обязательно для нового
    customerAddress: Address,
    emails?: string[],
    phoneNumber?: string
  }),
  
  carrier: JSON.stringify({
    id?: string,              // Опционально: ID существующего
    name: string,             // Обязательно для нового
    companyName?: string,
    mcNumber?: string,
    dotNumber?: string,
    phoneNumber?: string,
    email?: string,
    address?: Address,
    emails?: string[],
    photos?: string[]
  }),
  
  type: JSON.stringify({
    freight: boolean,
    vehicle: boolean
  }),
  
  freight?: JSON.stringify({
    shipment: FreightShipment[]
  }),
  
  vehicle?: JSON.stringify({
    shipment: VehicleShipment[],
    specialRequirements?: string
  }),
  
  pickup: JSON.stringify({
    locationName?: string,
    address: Address,
    contactPhone?: string,
    notes?: string,
    date?: string
  }),
  
  delivery: JSON.stringify({
    locationName?: string,
    address: Address,
    contactPhone?: string,
    notes?: string,
    date?: string
  }),
  
  status?: string,
  tracking?: string,
  files: File[]               // Массив файлов
}
```

### Создание Load - Response

```
{
  success: true,
  data: {
    id: string,
    orderId: string,
    billOfLadingNumber: string,
    customer: {
      id: string,
      companyName: string,
      customerAddress: Address,
      emails: string[],
      phoneNumber?: string
    },
    carrier: {
      id: string,
      name: string,
      companyName?: string,
      mcNumber?: string,
      dotNumber?: string,
      phoneNumber?: string,
      email?: string,
      address?: Address
    },
    type: {
      freight: boolean,
      vehicle: boolean
    },
    freight?: Freight,
    vehicle?: Vehicle,
    pickup: Location,
    delivery: Location,
    status: string,
    dates: {
      assignedDate?: string,
      pickupDate?: string,
      deliveryDate?: string
    },
    tracking?: string,
    documents: string[],
    bolPdfPath?: string,
    createdAt: string,
    updatedAt: string
  },
  message: "Load created successfully"
}
```

## 7. Сценарии использования

### Сценарий 1: Создание Load с новым Carrier и Customer

```
1. Пользователь вводит данные нового Customer
   → companyName: "New Company"
   
2. Пользователь вводит данные нового Carrier
   → name: "John Driver"
   → mcNumber: "MC123456"
   
3. Система проверяет:
   - Customer с companyName "New Company" не найден
   - Carrier с mcNumber "MC123456" не найден
   
4. Система создает:
   - Новый Customer в базе данных
   - Новый Carrier в базе данных
   - Новый Load со связями на созданные Customer и Carrier
   
5. Результат:
   - Customer сохранен для повторного использования
   - Carrier сохранен для повторного использования
   - Load создан успешно
```

### Сценарий 2: Создание Load с существующим Carrier

```
1. Пользователь ищет Carrier по имени "John Driver"
   → API возвращает список найденных Carriers
   
2. Пользователь выбирает существующего Carrier из списка
   → carrier.id: "507f1f77bcf86cd799439012"
   
3. При создании Load передается только ID:
   → carrier: { id: "507f1f77bcf86cd799439012" }
   
4. Система:
   - Находит существующий Carrier по ID
   - Использует его для создания Load
   - НЕ создает дубликат
   
5. Результат:
   - Load создан со связью на существующий Carrier
   - Carrier может быть обновлен новыми данными, если они переданы
```

### Сценарий 3: Обновление Load с изменением Carrier

```
1. Пользователь обновляет Load
   → Передает новые данные Carrier (без ID)
   → name: "John Driver Updated"
   → mcNumber: "MC123456"
   
2. Система:
   - Находит существующий Carrier по mcNumber "MC123456"
   - Обновляет его данными (name: "John Driver Updated")
   - Обновляет связь Load с Carrier
   - Удаляет связь со старым Carrier (если был другой)
   
3. Результат:
   - Carrier обновлен в базе данных
   - Load теперь связан с обновленным Carrier
   - Все другие Loads, связанные с этим Carrier, также видят обновленные данные
```

---

## Ключевые моменты

1. **Автоматическое создание:** Система автоматически создает Carrier и Customer, если они не найдены
2. **Повторное использование:** Созданные Carrier и Customer сохраняются и могут быть использованы в других Loads
3. **Умный поиск:** Поиск выполняется по нескольким полям с приоритетами
4. **Обновление данных:** Существующие записи обновляются новыми данными при необходимости
5. **Связи:** Все связи между Load, Carrier и Customer автоматически поддерживаются

