# –£–ª—É—á—à–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∏—Å—Ç–æ—Ä–∏–∏ LoadHistory

## –ü—Ä–æ–±–ª–µ–º–∞

–†–∞–Ω–µ–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ load'–∞ –≤ LoadHistory –∑–∞–ø–∏—Å—ã–≤–∞–ª–∏—Å—å –≤—Å–µ –ø–æ–ª—è —Å null –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, —á—Ç–æ –±—ã–ª–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –∏ –Ω–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ.

## –†–µ—à–µ–Ω–∏–µ

### 1. –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏

#### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ load'–∞:
```javascript
// ‚ùå –†–∞–Ω—å—à–µ (–ø–ª–æ—Ö–æ)
await this.createHistoryRecord(saved._id, 'created', req.user?.id, req.body);
// –°–æ–∑–¥–∞–≤–∞–ª–æ –∑–∞–ø–∏—Å–∏ —Ç–∏–ø–∞: { field: "vin", oldValue: null, newValue: "1HGBH41JXMN109186" }

// ‚úÖ –¢–µ–ø–µ—Ä—å (—Ö–æ—Ä–æ—à–æ)
await this.createHistoryRecord(saved._id, 'created', req.user?.id, []);
// –°–æ–∑–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ: { action: "created", changedBy: userId, changes: [] }
```

#### –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ load'–∞:
```javascript
// ‚úÖ –ó–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
const changes = this.getChanges(oldDoc, req.body);
// –§–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø—É—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
const filteredChanges = changes.filter(change => 
  change.oldValue !== change.newValue && 
  (change.oldValue !== null || change.newValue !== null)
);
```

### 2. –£–º–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π

```javascript
compareValues(oldValue, newValue) {
  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º null/undefined –ø–∞—Ä—ã
  if ((oldValue === null || oldValue === undefined) && 
      (newValue === null || newValue === undefined)) {
    return false;
  }
  
  // –û–±—ä–µ–∫—Ç—ã —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ JSON.stringify
  if (typeof oldValue === 'object' && typeof newValue === 'object') {
    return JSON.stringify(oldValue) !== JSON.stringify(newValue);
  }
  
  return oldValue !== newValue;
}
```

### 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–æ–ª–µ–π

```javascript
// –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è MongoDB
if (['_id', 'createdAt', 'updatedAt', '__v'].includes(key)) {
  return;
}
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É–ª—É—á—à–µ–Ω–∏–π

### ‚úÖ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

1. **–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ load'–∞:**
   - LoadHistory —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ `action: "created"` –∏ `changedBy`
   - –ù–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ `changes: []`)
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

2. **–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ load'–∞:**
   - –ó–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—è
   - –§–∏–ª—å—Ç—Ä—É—é—Ç—Å—è null ‚Üí null –∏–∑–º–µ–Ω–µ–Ω–∏—è
   - –ò–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è MongoDB

3. **–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ load'–∞:**
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è `action: "deleted"`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–º, –∫—Ç–æ —É–¥–∞–ª–∏–ª

### üìä –ü—Ä–∏–º–µ—Ä—ã LoadHistory –∑–∞–ø–∏—Å–µ–π:

#### –°–æ–∑–¥–∞–Ω–∏–µ load'–∞:
```json
{
  "loadId": "507f1f77bcf86cd799439011",
  "action": "created",
  "changedBy": "507f1f77bcf86cd799439012",
  "changes": []
}
```

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ load'–∞:
```json
{
  "loadId": "507f1f77bcf86cd799439011", 
  "action": "updated",
  "changedBy": "507f1f77bcf86cd799439012",
  "changes": [
    {
      "field": "status",
      "oldValue": "Listed",
      "newValue": "Dispatched"
    },
    {
      "field": "value",
      "oldValue": 1000,
      "newValue": 1500
    }
  ]
}
```

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:
```json
{
  "loadId": "507f1f77bcf86cd799439011",
  "action": "status_updated", 
  "changedBy": "507f1f77bcf86cd799439012",
  "changes": [
    {
      "field": "status",
      "oldValue": "Dispatched", 
      "newValue": "Picked up"
    }
  ]
}
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

### üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- –ú–µ–Ω—å—à–µ –∑–∞–ø–∏—Å–µ–π –≤ LoadHistory
- –ë—ã—Å—Ç—Ä–µ–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –∏—Å—Ç–æ—Ä–∏–∏
- –≠–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞:
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –¢–æ—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### üîç –û—Ç–ª–∞–¥–∫–∞:
- –ß–∏—Å—Ç–∞—è –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –õ–µ–≥–∫–æ –Ω–∞–π—Ç–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –ü–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### 1. –î–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è:
```javascript
// –ü–æ–¥—Å—á–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö load'–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
const createdLoads = await LoadHistory.countDocuments({
  action: 'created',
  changedBy: userId
});
```

### 2. –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:
```javascript
// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π load'–∞
const loadHistory = await LoadHistory.find({
  loadId: loadId,
  action: { $in: ['updated', 'status_updated'] }
}).sort({ createdAt: -1 });
```

### 3. –î–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:
```javascript
// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–µ–π—Å—Ç–≤–∏—è–º
const activityStats = await LoadHistory.aggregate([
  {
    $group: {
      _id: { action: "$action", user: "$changedBy" },
      count: { $sum: 1 }
    }
  }
]);
```

## –ú–∏–≥—Ä–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö

–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å LoadHistory —Å null –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Ö:

```javascript
// –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å–∏ —Å –ø—É—Å—Ç—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
await LoadHistory.deleteMany({
  action: 'created',
  'changes.field': { $exists: true }
});

// –ò–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏
await LoadHistory.updateMany(
  { action: 'created' },
  { $set: { changes: [] } }
);
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ LoadHistory:
- ‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏  
- ‚úÖ –õ–µ–≥–∫–∞ –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞ –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö
